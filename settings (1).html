<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Settings - Energy Dashboard</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95em;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 10px 0;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .phase-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 5px;
        }

        .phase-badge-1 {
            background: #cce5ff;
            color: #004085;
        }

        .phase-badge-3 {
            background: #d4edda;
            color: #155724;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .section-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .info-box p {
            margin: 5px 0;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        #qr-reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .current-config {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            font-weight: 500;
            color: #555;
        }

        .config-value {
            color: #333;
            font-size: 0.9em;
            max-width: 60%;
            word-break: break-all;
        }

        .phase-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .sheet-list {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
        }

        .sheet-list li {
            margin: 5px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.5em;
            }

            .config-value {
                max-width: 50%;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
            <p class="subtitle">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div id="connectionStatus"></div>
        </div>

        <!-- Current Configuration -->
        <div class="section" id="currentConfigSection">
            <div class="section-title">üìä ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="current-config" id="currentConfig">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p>
                </div>
            </div>
        </div>

        <!-- QR Code Scanner Section -->
        <div class="section">
            <div class="section-title">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR Code</div>
            
            <div class="info-box">
                <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong></p>
                <p>1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <p>2. ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏à‡∏≤‡∏Å URL ‡∏Ç‡∏≠‡∏á Sheet</p>
                <p>3. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á" ‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô QR Code</p>
                <p>4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö 1 ‡πÄ‡∏ü‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ 3 ‡πÄ‡∏ü‡∏™</p>
            </div>

            <div class="qr-container">
                <div id="qr-reader" class="hidden"></div>
            </div>

            <button id="startScanBtn" class="btn btn-primary" onclick="startQrScan()">
                üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR Code
            </button>

            <button id="stopScanBtn" class="btn btn-secondary hidden" onclick="stopQrScan()">
                ‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô
            </button>
        </div>

        <!-- Manual Input Section -->
        <div class="section">
            <div class="section-title">‚å®Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</div>
            
            <div class="input-group">
                <label for="manualUrl">Google Sheet URL:</label>
                <input 
                    type="text" 
                    id="manualUrl" 
                    placeholder="https://docs.google.com/spreadsheets/d/..."
                >
            </div>

            <button class="btn btn-success" onclick="testAndSaveUrl()">
                ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL
            </button>

            <div class="info-box">
                <p><strong>üí° ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</strong></p>
                <p>‚Ä¢ URL ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Google Sheets</p>
                <p>‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏£‡πå Spreadsheet ‡πÉ‡∏´‡πâ Script ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</p>
                <p><strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 1 ‡πÄ‡∏ü‡∏™:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Energy_Data_A</p>
                <p><strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 3 ‡πÄ‡∏ü‡∏™:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Energy_Data_A/B/C</p>
            </div>
        </div>

        <!-- Test Connection Result -->
        <div class="section hidden" id="testResultSection">
            <div class="section-title">üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            <div id="testResult"></div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Back to Dashboard -->
        <div class="back-link">
            <a href="dashboard.html">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Dashboard</a>
        </div>
    </div>

    <!-- Firebase & QR Scanner Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCK-pRuG2UBYzbzyg6NEoJqFeM9bVokKsU",
            authDomain: "energy-dashboard-3phase.firebaseapp.com",
            projectId: "energy-dashboard-3phase",
            storageBucket: "energy-dashboard-3phase.firebasestorage.app",
            messagingSenderId: "538942868301",
            appId: "1:538942868301:web:e5075552648f5135a24504"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // API Configuration
        const CONFIG = {
            apiUrl: "YOUR_WEB_APP_URL" // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend Web App URL
        };

        let html5QrCode = null;

        // ========================================
        // INITIALIZATION
        // ========================================

        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            await loadCurrentConfig();
        });

        // ========================================
        // QR CODE SCANNER
        // ========================================

        function startQrScan() {
            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');

            qrReader.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');

            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err);
                stopQrScan();
            });
        }

        function stopQrScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                });
            }

            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');

            qrReader.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code detected:', decodedText);
            
            stopQrScan();

            if (decodedText.includes('docs.google.com/spreadsheets')) {
                document.getElementById('manualUrl').value = decodedText;
                showAlert('success', '‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
                
                setTimeout(() => testAndSaveUrl(), 1000);
            } else {
                showAlert('error', 'QR Code ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Sheets URL');
            }
        }

        function onScanFailure(error) {
            // Ignore scan failures
        }

        // ========================================
        // API FUNCTIONS
        // ========================================

        async function loadCurrentConfig() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const url = `${CONFIG.apiUrl}?action=getSheetUrl&token=${token}`;
                
                const response = await fetch(url);
                const data = await response.json();

                const statusDiv = document.getElementById('connectionStatus');
                const configDiv = document.getElementById('currentConfig');

                if (data.success && data.hasSheet && data.sheetUrl) {
                    // Get phase info
                    const phaseUrl = `${CONFIG.apiUrl}?action=detectPhases&token=${token}`;
                    const phaseResponse = await fetch(phaseUrl);
                    const phaseData = await phaseResponse.json();

                    statusDiv.innerHTML = '<span class="status-badge status-connected">üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>';
                    
                    let phaseInfo = '';
                    if (phaseData.success) {
                        const phaseClass = phaseData.is3Phase ? 'phase-badge-3' : 'phase-badge-1';
                        const phaseText = phaseData.is3Phase ? '3 ‡πÄ‡∏ü‡∏™' : '1 ‡πÄ‡∏ü‡∏™';
                        phaseInfo = `<span class="phase-badge ${phaseClass}">${phaseText}</span>`;
                    }
                    
                    configDiv.innerHTML = `
                        <div class="config-item">
                            <span class="config-label">üìä Spreadsheet URL:</span>
                            <span class="config-value">${shortenUrl(data.sheetUrl)}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">üë§ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span>
                            <span class="config-value">${user.email}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö:</span>
                            <span class="config-value">${phaseInfo}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">üìÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                            <span class="config-value">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        </div>
                    `;

                    if (phaseData.success && phaseData.availableSheets) {
                        configDiv.innerHTML += `
                            <div class="phase-info">
                                <strong>üìë Sheets ‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong>
                                <div class="sheet-list">
                                    <ul>
                                        ${phaseData.availableSheets.energy.map(s => '<li>‚úì ' + s + '</li>').join('')}
                                        ${phaseData.availableSheets.hourly.map(s => '<li>‚úì ' + s + '</li>').join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('manualUrl').value = data.sheetUrl;
                } else {
                    statusDiv.innerHTML = '<span class="status-badge status-disconnected">üî¥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>';
                    
                    configDiv.innerHTML = `
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong><br>
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Load config error:', error);
                showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        async function testAndSaveUrl() {
            const urlInput = document.getElementById('manualUrl');
            const sheetUrl = urlInput.value.trim();

            if (!sheetUrl) {
                showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL');
                return;
            }

            if (!sheetUrl.includes('docs.google.com/spreadsheets')) {
                showAlert('error', 'URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Google Sheets URL');
                return;
            }

            showAlert('info', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                    return;
                }

                const token = await user.getIdToken();

                // Test access
                const testUrl = `${CONFIG.apiUrl}?action=testSheetAccess&token=${token}&sheetUrl=${encodeURIComponent(sheetUrl)}`;
                const testResponse = await fetch(testUrl);
                const testData = await testResponse.json();

                if (!testData.success) {
                    showAlert('error', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Spreadsheet: ' + testData.error);
                    
                    document.getElementById('testResultSection').classList.remove('hidden');
                    document.getElementById('testResult').innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</strong><br>
                            ${testData.error}<br><br>
                            <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>
                            1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
                            2. ‡∏Ñ‡∏•‡∏¥‡∏Å "Share" ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô<br>
                            3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "Anyone with the link" ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ Script Email<br>
                            4. ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        </div>
                    `;
                    return;
                }

                // Show test results with phase detection
                const phaseClass = testData.is3Phase ? 'phase-badge-3' : 'phase-badge-1';
                const phaseText = testData.is3Phase ? '3 ‡πÄ‡∏ü‡∏™' : '1 ‡πÄ‡∏ü‡∏™';

                document.getElementById('testResultSection').classList.remove('hidden');
                document.getElementById('testResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br><br>
                        üìä <strong>Spreadsheet:</strong> ${testData.spreadsheetName}<br>
                        ‚ö° <strong>‡∏£‡∏∞‡∏ö‡∏ö:</strong> <span class="phase-badge ${phaseClass}">${phaseText}</span><br>
                        üìë <strong>Phases:</strong> ${testData.phases ? testData.phases.join(', ') : 'A'}<br>
                        <br>
                        <strong>Energy Data Sheets:</strong><br>
                        ${testData.availableSheets.energy.map(s => '‚Ä¢ ' + s).join('<br>')}<br>
                        <br>
                        <strong>Hourly Data Sheets:</strong><br>
                        ${testData.availableSheets.hourly.length > 0 ? 
                          testData.availableSheets.hourly.map(s => '‚Ä¢ ' + s).join('<br>') : 
                          '‚Ä¢ ‡∏à‡∏∞ aggregate ‡∏à‡∏≤‡∏Å Energy Data'}
                    </div>
                `;

                // Save URL
                const saveUrl = `${CONFIG.apiUrl}?action=saveSheetUrl&token=${token}&sheetUrl=${encodeURIComponent(sheetUrl)}`;
                const saveResponse = await fetch(saveUrl);
                const saveData = await saveResponse.json();

                if (saveData.success) {
                    showAlert('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...');
                    
                    setTimeout(() => {
                        loadCurrentConfig();
                        document.getElementById('testResultSection').classList.add('hidden');
                    }, 2000);
                } else {
                    showAlert('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + saveData.error);
                }

            } catch (error) {
                console.error('Test/Save error:', error);
                showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function shortenUrl(url) {
            if (url.length > 50) {
                return url.substring(0, 50) + '...';
            }
            return url;
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-error' : 'alert-info';
            
            container.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
